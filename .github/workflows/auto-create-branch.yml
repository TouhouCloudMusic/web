name: Create Branch for Todo Task

on:
  issues:
    types: [opened]

jobs:
  create-branch-for-task:
    if: contains(github.event.issue.labels.*.name, 'Todo Task')
    runs-on: ubuntu-latest

    steps:
    - name: Checkout main branch
      uses: actions/checkout@v4
      with:
        ref: main

    - name: Set up Git config
      run: |
        git config --global user.name "${{ github.actor }}"
        git config --global user.email "${{ github.actor }}@users.noreply.github.com"

    - name: Generate branch name
      id: vars
      run: |
        ISSUE_NUMBER=${{ github.event.issue.number }}
        ISSUE_TITLE="${{ github.event.issue.title }}"
        BRANCH_NAME="issue-${ISSUE_NUMBER}-$(echo "$ISSUE_TITLE" | tr '[:upper:]' '[:lower:]' | sed -E 's/[^a-z0-9]+/-/g' | sed -E 's/^-|-$//g')"
        echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

    - name: Create and push branch
      run: |
        git fetch origin main
        git checkout -b ${{ steps.vars.outputs.branch_name }} origin/main
        git push origin ${{ steps.vars.outputs.branch_name }}

    - name: Comment on the issue
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const issue_number = context.issue.number;
          const title = context.payload.issue.title.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '');
          const branch_name = `issue-${issue_number}-${title}`;
          github.rest.issues.createComment({
            ...context.repo,
            issue_number,
            body: `🚀 自动为任务创建了分支：\`${branch_name}\`。\n请在此分支下开发并提交 PR！`
          });
